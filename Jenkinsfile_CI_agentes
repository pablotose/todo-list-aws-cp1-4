pipeline {
  agent any

  options {
    timestamps()
    skipDefaultCheckout(true)
  }

  environment {
    REPO_URL        = "https://github.com/pablotose/todo-list-aws-cp1-3.git"
    CONFIG_REPO_URL = "https://github.com/pablotose/todo-list-aws-config.git"

    REGION     = "us-east-1"
    STACK_NAME = "todo-list-aws"

    VENV       = ".venv"
    REPORT_DIR = "reports"
  }

  stages {

    stage('Get Code') {
      steps {
        sh '''#!/bin/bash
          set -e
          echo "== AGENT INFO (Get Code) =="
          echo "NODE_NAME=$NODE_NAME"
          echo "EXECUTOR_NUMBER=$EXECUTOR_NUMBER"
          whoami
          hostname
          pwd
          echo "==========================="
        '''

        // Código (develop)
        checkout([$class: 'GitSCM',
          branches: [[name: '*/develop']],
          userRemoteConfigs: [[
            url: "${REPO_URL}",
            credentialsId: 'github-token'
          ]]
        ])

        // Config (staging) -> samconfig.toml
        sh '''#!/bin/bash
          set -euxo pipefail
          rm -rf config-repo
          git clone -b staging "${CONFIG_REPO_URL}" config-repo
          cp config-repo/samconfig.toml .
          echo "== samconfig.toml (staging) =="
          cat samconfig.toml
        '''

        // Compartir con agentes
        stash name: 'src', includes: '**/*'
      }
    }

    stage('Static Test (agent: static)') {
      agent { label 'static' }
      steps {
        sh '''#!/bin/bash
          set -e
          echo "== AGENT INFO (Static Test) =="
          echo "NODE_NAME=$NODE_NAME"
          echo "EXECUTOR_NUMBER=$EXECUTOR_NUMBER"
          whoami
          hostname
          pwd
          echo "================================"
        '''

        deleteDir()
        unstash 'src'

        sh '''#!/bin/bash
          set -euxo pipefail

          python3 -m venv "${VENV}"
          source "${VENV}/bin/activate"

          pip install --upgrade pip
          pip install flake8 bandit

          mkdir -p "${REPORT_DIR}/flake8"
          mkdir -p "${REPORT_DIR}/bandit"

          # Solo /src (como pide el enunciado)
          flake8 src --exit-zero --tee --output-file "${REPORT_DIR}/flake8/flake8.txt" || true
          bandit -r src -f txt -o "${REPORT_DIR}/bandit/bandit.txt" || true
        '''
      }
      post {
        always {
          archiveArtifacts artifacts: 'reports/**', fingerprint: true
        }
      }
    }

    stage('Deploy (Staging)') {
      steps {
        sh '''#!/bin/bash
          set -e
          echo "== AGENT INFO (Deploy) =="
          echo "NODE_NAME=$NODE_NAME"
          echo "EXECUTOR_NUMBER=$EXECUTOR_NUMBER"
          whoami
          hostname
          pwd
          echo "========================="
        '''

        deleteDir()
        unstash 'src'

        sh '''#!/bin/bash
          set -euxo pipefail

          # Limpieza build local
          rm -rf .aws-sam

          # Validar / Build
          sam validate --region "${REGION}"
          sam build

          # (Opcional, pero útil en logs)
          aws sts get-caller-identity
          echo "Checking IAM role LabRole exists..."
          aws iam get-role --role-name LabRole

          # Deploy NO interactivo usando samconfig.toml (staging)
          sam deploy \
            --region "${REGION}" \
            --stack-name "${STACK_NAME}" \
            --no-confirm-changeset \
            --no-fail-on-empty-changeset

          # Obtener BaseUrlApi del stack (Outputs)
          BASE_URL=$(aws cloudformation describe-stacks \
            --region "${REGION}" \
            --stack-name "${STACK_NAME}" \
            --query "Stacks[0].Outputs[?OutputKey=='BaseUrlApi'].OutputValue" \
            --output text)

          echo "BASE_URL=${BASE_URL}" > base_url.env
          echo "API Base URL: ${BASE_URL}"
        '''

        // Pasar URL al agente REST
        stash name: 'baseurl', includes: 'base_url.env'
      }
    }

    stage('Rest Test (curl) (agent: rest)') {
      agent { label 'rest' }
      steps {
        sh '''#!/bin/bash
          set -e
          echo "== AGENT INFO (Rest Test) =="
          echo "NODE_NAME=$NODE_NAME"
          echo "EXECUTOR_NUMBER=$EXECUTOR_NUMBER"
          whoami
          hostname
          pwd
          echo "============================"
        '''

        deleteDir()
        unstash 'src'
        unstash 'baseurl'

        sh '''#!/bin/bash
          set -e
          source base_url.env

          echo "Testing API: ${BASE_URL}"

          # POST
          RESP_POST=$(curl -sf --max-time 10 -X POST "${BASE_URL}/todos" \
            -H "Content-Type: application/json" \
            -d '{ "text": "Test desde Jenkins" }')

          echo "POST response: $RESP_POST"

          # Extraer TODO_ID (soporta body string dentro del JSON)
          TODO_ID=$(python3 - "$RESP_POST" <<'PY'
import json, sys
raw = sys.argv[1].strip()
j = json.loads(raw)
if isinstance(j, dict) and "body" in j and isinstance(j["body"], str):
    j = json.loads(j["body"])
print(j.get("id",""))
PY
)
          echo "TODO_ID=$TODO_ID"
          [ -n "$TODO_ID" ]

          # GET lista
          curl -sf --max-time 10 "${BASE_URL}/todos"
          echo "GET /todos OK"

          # GET por id
          curl -sf --max-time 10 "${BASE_URL}/todos/${TODO_ID}"
          echo "GET /todos/{id} OK"

          # DELETE
          curl -sf --max-time 10 -X DELETE "${BASE_URL}/todos/${TODO_ID}"
          echo "DELETE OK"

          echo "✅ REST TEST PASSED (CRUD completo)"
        '''
      }
    }

    stage('Promote') {
      steps {
        sh '''#!/bin/bash
          set -e
          echo "== AGENT INFO (Promote) =="
          echo "NODE_NAME=$NODE_NAME"
          echo "EXECUTOR_NUMBER=$EXECUTOR_NUMBER"
          whoami
          hostname
          pwd
          echo "=========================="
        '''

        // IMPORTANTE: checkout para tener .git (stash/unstash no lo incluye)
        checkout([$class: 'GitSCM',
          branches: [[name: '*/develop']],
          userRemoteConfigs: [[
            url: "${REPO_URL}",
            credentialsId: 'github-token'
          ]]
        ])

        withCredentials([usernamePassword(credentialsId: 'github-token', usernameVariable: 'GIT_USER', passwordVariable: 'GIT_PAT')]) {
          sh '''#!/bin/bash
            set -euxo pipefail

            git config user.email "jenkins@local"
            git config user.name  "jenkins"

            git fetch origin

            git checkout master || git checkout -b master origin/master
            git pull "https://${GIT_USER}:${GIT_PAT}@github.com/pablotose/todo-list-aws-cp1-3.git" master

            git merge --no-ff origin/develop -m "Promote: merge develop into master"

            git push "https://${GIT_USER}:${GIT_PAT}@github.com/pablotose/todo-list-aws-cp1-3.git" master
          '''
        }
      }
    }

  } // stages

  post {
    always {
      echo "Pipeline finished with status: ${currentBuild.currentResult}"
    }
  }
}
