pipeline {
agent any

options {
timestamps()
skipDefaultCheckout(true)
}

environment {
REPO_URL = "https://github.com/pablotose/todo-list-aws-cp1-3.git
"
REGION = "us-east-1"
STACK_NAME = "todo-list-aws"
VENV = ".venv"
}

stages {

stage('Get Code') {
  steps {
    checkout([$class: 'GitSCM',
      branches: [[name: '*/master']],
      userRemoteConfigs: [[
        url: "${REPO_URL}",
        credentialsId: 'github-token'
      ]]
    ])
  }
}

stage('Deploy (Production)') {
  steps {
    sh '''
      set -euxo pipefail

      rm -f samconfig.toml
      rm -rf .aws-sam

      sam validate --region ${REGION}
      sam build

      sam deploy \
        --region ${REGION} \
        --stack-name ${STACK_NAME} \
        --resolve-s3 \
        --force-upload \
        --parameter-overrides Stage=production \
        --no-confirm-changeset \
        --no-fail-on-empty-changeset

      BASE_URL=$(aws cloudformation describe-stacks \
        --region ${REGION} \
        --stack-name ${STACK_NAME} \
        --query "Stacks[0].Outputs[?OutputKey=='BaseUrlApi'].OutputValue" \
        --output text)

      echo "BASE_URL=${BASE_URL}" > base_url.env
    '''
  }
}

stage('Rest Test (Read Only)') {
  steps {
    sh '''
      set -e
      source base_url.env

      echo "Testing production API: ${BASE_URL}"

      echo "== GET /todos =="
      curl -sS -i "${BASE_URL}/todos"

      echo "== GET /todos/{id} (solo si existen datos) =="

      # No hacemos POST, PUT ni DELETE para no modificar producci√≥n

      echo "REST READ TEST PASSED"
    '''
  }
}

}

post {
always {
echo "CD Pipeline finished with status: ${currentBuild.currentResult}"
}
}
}
