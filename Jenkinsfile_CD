pipeline {
  agent any

  options {
    timestamps()
    skipDefaultCheckout(true)
  }

  environment {
    REPO_URL   = "https://github.com/pablotose/todo-list-aws-cp1-3.git"
    REGION     = "us-east-1"
    STACK_NAME = "todo-list-aws"
  }

  stages {

    stage('Get Code') {
      steps {
        checkout([$class: 'GitSCM',
          branches: [[name: '*/master']],
          userRemoteConfigs: [[
            url: "${REPO_URL}",
            credentialsId: 'github-token'
          ]]
        ])
      }
    }

    stage('Deploy (Production)') {
      steps {
        sh '''#!/bin/bash
          set -euxo pipefail

          rm -f samconfig.toml
          rm -rf .aws-sam

          sam validate --region "${REGION}"
          sam build

          sam deploy \
            --region "${REGION}" \
            --stack-name "${STACK_NAME}" \
            --resolve-s3 \
            --force-upload \
            --parameter-overrides Stage=production \
            --no-confirm-changeset \
            --no-fail-on-empty-changeset

          BASE_URL=$(aws cloudformation describe-stacks \
            --region "${REGION}" \
            --stack-name "${STACK_NAME}" \
            --query "Stacks[0].Outputs[?OutputKey=='BaseUrlApi'].OutputValue" \
            --output text)

          echo "BASE_URL=${BASE_URL}" > base_url.env
          echo "Production API Base URL: ${BASE_URL}"
        '''
      }
    }

    stage('Rest Test (Read Only)') {
      steps {
        sh '''#!/bin/bash
          set -e
          source base_url.env

          echo "Testing production API (read-only): ${BASE_URL}"

          echo "== GET /todos =="
          curl -sf --max-time 10 "${BASE_URL}/todos"
          echo ""
          echo "GET /todos OK"

          echo "âœ… REST READ-ONLY TEST PASSED"
        '''
      }
    }
  }

  post {
    always {
      echo "CD Pipeline finished with status: ${currentBuild.currentResult}"
    }
  }
}
